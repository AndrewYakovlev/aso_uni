#!/bin/bash

echo "üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
echo "======================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
if ! curl -s http://localhost:3000 > /dev/null; then
    echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ. –ó–∞–ø—É—Å—Ç–∏—Ç–µ 'npm run dev' –≤ –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ."
    exit 1
fi

echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ"
echo ""

# –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
echo "üìù –¢–µ—Å—Ç 1: –î–æ—Å—Ç—É–ø –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
echo "---------------------------------"

RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/panel)
echo "HTTP –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞: $RESPONSE"

if [ "$RESPONSE" == "307" ] || [ "$RESPONSE" == "308" ]; then
    echo "‚úÖ –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞"
else
    echo "‚ùå –û–∂–∏–¥–∞–ª—Å—è —Ä–µ–¥–∏—Ä–µ–∫—Ç (307/308), –ø–æ–ª—É—á–µ–Ω –∫–æ–¥ $RESPONSE"
fi
echo ""

# –¢–µ—Å—Ç 2: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
echo "üìù –¢–µ—Å—Ç 2: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞"
echo "--------------------------------"

PHONE="+79998888888"  # –ú–µ–Ω–µ–¥–∂–µ—Ä –∏–∑ seed

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º OTP
echo "–û—Ç–ø—Ä–∞–≤–∫–∞ OTP..."
OTP_RESPONSE=$(curl -s -X POST http://localhost:3000/api/v1/auth/send-otp \
  -H "Content-Type: application/json" \
  -d "{\"phone\": \"$PHONE\"}" \
  -c panel_cookies.txt)

SUCCESS=$(echo "$OTP_RESPONSE" | jq -r '.success')
if [ "$SUCCESS" == "true" ]; then
    echo "‚úÖ OTP –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"
    echo "‚ö†Ô∏è  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ OTP"
    exit 1
fi

# –ñ–¥–µ–º –≤–≤–æ–¥–∞ –∫–æ–¥–∞
echo ""
echo "üì± –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ (4 —Ü–∏—Ñ—Ä—ã):"
read -r OTP_CODE

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥
echo ""
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞..."
VERIFY_RESPONSE=$(curl -s -X POST http://localhost:3000/api/v1/auth/verify-otp \
  -H "Content-Type: application/json" \
  -d "{
    \"phone\": \"$PHONE\",
    \"code\": \"$OTP_CODE\"
  }" \
  -b panel_cookies.txt \
  -c panel_cookies.txt)

USER_ROLE=$(echo "$VERIFY_RESPONSE" | jq -r '.data.user.role')
if [ "$USER_ROLE" == "MANAGER" ]; then
    echo "‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
    exit 1
fi
echo ""

# –¢–µ—Å—Ç 3: –î–æ—Å—Ç—É–ø –∫ –ø–∞–Ω–µ–ª–∏ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
echo "üìù –¢–µ—Å—Ç 3: –î–æ—Å—Ç—É–ø –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∫ –ø–∞–Ω–µ–ª–∏"
echo "------------------------------------"

PANEL_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
  -b panel_cookies.txt \
  http://localhost:3000/panel)

echo "HTTP –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞: $PANEL_RESPONSE"

if [ "$PANEL_RESPONSE" == "200" ]; then
    echo "‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–∞–Ω–µ–ª–∏"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ (–∫–æ–¥ $PANEL_RESPONSE)"
fi
echo ""

# –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ API endpoint –ø–∞–Ω–µ–ª–∏
echo "üìù –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ API"
echo "-----------------------------------"

ME_RESPONSE=$(curl -s http://localhost:3000/api/v1/auth/me \
  -b panel_cookies.txt)

USER_TYPE=$(echo "$ME_RESPONSE" | jq -r '.data.type')
USER_ROLE=$(echo "$ME_RESPONSE" | jq -r '.data.user.role')

if [ "$USER_TYPE" == "user" ] && [ "$USER_ROLE" == "MANAGER" ]; then
    echo "‚úÖ API –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–æ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞"
    echo "   –†–æ–ª—å: $USER_ROLE"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–æ–ª–∏"
fi
echo ""

# –û—á–∏—Å—Ç–∫–∞
rm -f panel_cookies.txt

echo "üéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "–î–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000/panel"
echo "2. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –∫–∞–∫ –º–µ–Ω–µ–¥–∂–µ—Ä –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:"
echo "   - –ê–¥–º–∏–Ω: +79999999999"
echo "   - –ú–µ–Ω–µ–¥–∂–µ—Ä: +79998888888"
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–≤–∏–≥–∞—Ü–∏—é –∏ –¥–æ—Å—Ç—É–ø –∫ —Ä–∞–∑–¥–µ–ª–∞–º"